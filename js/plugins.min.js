$(document).ready(function(){const CONFIG={BRUSH_SIZE_STEPS:[1,5,8,12,20,30],ZOOM:{min:0.5,max:2.0,step:0.1},DEFAULT_BRUSH_COLOR:'#ff0000',DEFAULT_BRUSH_SIZE_INDEX:1,TITLE_SELECTORS:'h1, h2, h3, h4, h5'};const $document=$(document);const $window=$(window);const $body=$('body');const $main=$('.playback #playbackMain');const $playbackContent=$('.playback #playbackContent');const $toolbar=$('.playback #playbackToolbar');let $originalContent=$('.post-content');const $canvas=$('.playback #playbackDrawingCanvas');const canvas=$canvas[0];let ctx=null;const $brushSizeControls=$('.playback #brushSizeControls');const $sizePrev=$('.playback .brush-size-controls .size-prev');const $disableDrawBtn=$('.playback #disableDrawBtn');const $drawBtn=$('.playback #drawBtn');const $eraserBtn=$('.playback #eraserBtn');const $sizeDownBtn=$('.playback #sizeDownBtn');const $sizeUpBtn=$('.playback #sizeUpBtn');const $sizeValue=$('.playback #sizeValue');const $colorPicker=$('.playback #colorPicker');const $clearBtn=$('.playback #clearBtn');const $zoomOutBtn=$('.playback #zoomOutBtn');const $zoomInBtn=$('.playback #zoomInBtn');const $zoomResetBtn=$('.playback #zoomResetBtn');const $zoomValue=$('.playback #zoomValue');const $fullscreenBtn=$('.playback #fullscreenBtn');const $enterPlayback=$('#enterPlayback');const $exitBtn=$('.playback #exitBtn');const $tocBtn=$('.playback #tocBtn');const $playbackTOC=$('.playback #playbackTOC');const $tocList=$playbackTOC.find('.playback-toc-list');const $tocCloseBtn=$('.playback #tocCloseBtn');const state={isDrawing:false,isEraserActive:false,brushColor:CONFIG.DEFAULT_BRUSH_COLOR,brushSize:CONFIG.BRUSH_SIZE_STEPS[CONFIG.DEFAULT_BRUSH_SIZE_INDEX],currentSizeIndex:CONFIG.DEFAULT_BRUSH_SIZE_INDEX,zoomScale:1.0,isTOCActive:false,isEventsBound:false};function throttle(fn,delay=100){let timer=null;return function(...args){if(!timer){timer=setTimeout(()=>{fn.apply(this,args);timer=null},delay)}}}function initCanvas(){if(!canvas){return}const viewportWidth=$window.width();const viewportHeight=$window.height();const dpr=window.devicePixelRatio||1;canvas.width=viewportWidth*dpr;canvas.height=viewportHeight*dpr;canvas.style.width=`${viewportWidth}px`;canvas.style.height=`${viewportHeight}px`;canvas.style.webkitTouchCallout='none';canvas.style.webkitUserSelect='none';ctx=canvas.getContext('2d');if(!ctx){return}ctx.scale(dpr,dpr);ctx.lineCap='round';ctx.lineJoin='round';clearCanvas()}function clearCanvas(){if(!ctx){return}ctx.clearRect(0,0,$window.width(),$window.height())}function getCanvasPos(e){return{x:e.clientX,y:e.clientY}}function getEventPos(e){if(e.type.includes('touch')){const touch=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0];return{x:touch.clientX,y:touch.clientY}}return{x:e.clientX,y:e.clientY}}function preventTouchDefault(e){if(e.target===canvas||$(e.target).closest($canvas).length){e.preventDefault();e.stopPropagation()}}const throttledInitCanvas=throttle(initCanvas,200);function enterFullscreen(){const elem=document.documentElement;if(elem.requestFullscreen){elem.requestFullscreen()}else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen()}else if(elem.msRequestFullscreen){elem.msRequestFullscreen()}updateFullscreenBtn(true);throttledInitCanvas()}function exitFullscreen(){if(document.exitFullscreen){document.exitFullscreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}updateFullscreenBtn(false);throttledInitCanvas()}function updateFullscreenBtn(isFullscreen){const icon=isFullscreen?'fa-compress':'fa-expand';const tooltip=isFullscreen?'退出全屏':'进入全屏';$fullscreenBtn.html(`<i class="fas ${icon}"></i>`).attr('data-tooltip',tooltip)}function isFullscreenMode(){return!!document.fullscreenElement||!!document.webkitFullscreenElement||!!document.msFullscreenElement}function disableDrawMode(){state.isDrawing=false;state.isEraserActive=false;$canvas.removeClass('drawing');clearCanvas();$disableDrawBtn.addClass('active');$drawBtn.removeClass('active');$eraserBtn.removeClass('active')}function updateBrushSize(){state.brushSize=CONFIG.BRUSH_SIZE_STEPS[state.currentSizeIndex];$sizeValue.text(state.brushSize);$brushSizeControls.attr('data-size',state.brushSize);$sizePrev.css('color',state.brushColor);$sizeDownBtn.prop('disabled',state.currentSizeIndex<=0);$sizeUpBtn.prop('disabled',state.currentSizeIndex>=CONFIG.BRUSH_SIZE_STEPS.length-1)}function updateZoom(){const zoomPercent=Math.round(state.zoomScale*100);$zoomValue.text(`${zoomPercent}%`);$playbackContent.css({'transform':`scale(${state.zoomScale})`,'transform-origin':'center top'});$zoomOutBtn.prop('disabled',state.zoomScale<=CONFIG.ZOOM.min);$zoomInBtn.prop('disabled',state.zoomScale>=CONFIG.ZOOM.max)}function resetZoom(){state.zoomScale=1.0;updateZoom()}function forceLoadLazyImages($container){if(!$container||!$container.length){return}$container.find('img.lazyload').each(function(){const $img=$(this);const src=$img.attr('data-original')||$img.attr('data-src')||$img.attr('src');if(src){$img.attr('src',src).removeClass('lazyload')}})}function renderTOC(){$tocList.off('.playback');$playbackTOC.off('.playback');$tocList.empty();const $titles=$playbackContent.find(CONFIG.TITLE_SELECTORS);if(!$titles.length){return}$titles.each(function(index){const $title=$(this);const titleText=$title.text().trim();if(!titleText){return}const titleId=`playback-toc-title-${index}`;$title.attr('id',titleId);const level=parseInt($title.prop('tagName').replace('H',''));const tocItem=`<li class="playback-toc-item playback-toc-level-${level}"><a href="#${titleId}"class="playback-toc-link"data-index="${index}">${titleText}</a></li>`;$tocList.append(tocItem)});bindTOCClick()}function bindTOCClick(){if(!$playbackTOC.length||!$tocList.length){return}$tocList.find('.playback-toc-link').off('click.playback').on('click.playback',function(e){e.preventDefault();e.stopPropagation();const index=parseInt($(this).data('index'));const $target=$playbackContent.find(CONFIG.TITLE_SELECTORS).eq(index);if(!$target.length){return}const titleOffsetInContent=$target[0].offsetTop;const scaledOffset=titleOffsetInContent*state.zoomScale;const finalOffset=scaledOffset-60;const scrollContainer=$main[0];scrollContainer.scrollTop=finalOffset});$playbackTOC.off('click.playback','.playback-toc-link').on('click.playback','.playback-toc-link',function(e){e.preventDefault();e.stopPropagation();const index=parseInt($(this).data('index'));const $target=$playbackContent.find(CONFIG.TITLE_SELECTORS).eq(index);if($target.length){$main[0].scrollTop=($target[0].offsetTop*state.zoomScale)-60}})}function showTOC(){if(!$playbackTOC.length){return}state.isTOCActive=true;$playbackTOC.addClass('active');$tocBtn.addClass('active');$tocBtn.attr('data-tooltip','隐藏目录')}function hideTOC(){if(!$playbackTOC.length){return}state.isTOCActive=false;$playbackTOC.removeClass('active');$tocBtn.removeClass('active');$tocBtn.attr('data-tooltip','显示目录')}function toggleTOC(){state.isTOCActive?hideTOC():showTOC()}function bindEvents(){if(state.isEventsBound){return}$tocCloseBtn.off('click.playback').on('click.playback',function(e){e.preventDefault();e.stopPropagation();hideTOC()});$tocBtn.off('click.playback').on('click.playback',function(){if($tocList.find('.playback-toc-link').length===0){renderTOC()}toggleTOC()});$document.on('fullscreenchange.playback webkitfullscreenchange.playback MSFullscreenChange.playback',function(){updateFullscreenBtn(isFullscreenMode());throttledInitCanvas()});$fullscreenBtn.off('click.playback').on('click.playback',function(){isFullscreenMode()?exitFullscreen():enterFullscreen()});$exitBtn.off('click.playback').on('click.playback',function(){if(isFullscreenMode()){exitFullscreen()}$main.removeClass('active');$toolbar.hide();$body.css('overflow','auto');disableDrawMode();$playbackContent.css('transform','none');$tocList.empty();$playbackContent.html('');$originalContent=null;hideTOC();$tocBtn.removeClass('active');$tocBtn.attr('data-tooltip','显示目录');destroyEvents()});$disableDrawBtn.off('click.playback').on('click.playback',disableDrawMode);$drawBtn.off('click.playback').on('click.playback',function(){state.isEraserActive=false;$canvas.addClass('drawing');$drawBtn.addClass('active');$eraserBtn.removeClass('active');$disableDrawBtn.removeClass('active')});$eraserBtn.off('click.playback').on('click.playback',function(){state.isEraserActive=true;$canvas.addClass('drawing');$eraserBtn.addClass('active');$drawBtn.removeClass('active');$disableDrawBtn.removeClass('active')});$sizeDownBtn.off('click.playback').on('click.playback',function(){if(state.currentSizeIndex>0){state.currentSizeIndex--;updateBrushSize()}});$sizeUpBtn.off('click.playback').on('click.playback',function(){if(state.currentSizeIndex<CONFIG.BRUSH_SIZE_STEPS.length-1){state.currentSizeIndex++;updateBrushSize()}});$colorPicker.off('change.playback').on('change.playback',function(){state.brushColor=$(this).val();$sizePrev.css('color',state.brushColor)});$clearBtn.off('click.playback').on('click.playback',clearCanvas);$canvas.off('mousedown.playback touchstart.playback').on('mousedown.playback touchstart.playback',function(e){preventTouchDefault(e);if(!$canvas.hasClass('drawing')||!ctx){return}state.isDrawing=true;const pos=getEventPos(e);ctx.beginPath();ctx.moveTo(pos.x,pos.y);if(state.isEraserActive){ctx.globalCompositeOperation='destination-out';ctx.strokeStyle='rgba(0,0,0,1)';ctx.lineWidth=state.brushSize*2}else{ctx.globalCompositeOperation='source-over';ctx.strokeStyle=state.brushColor;ctx.lineWidth=state.brushSize}$document.off('mousemove.playback touchmove.playback').on('mousemove.playback touchmove.playback',function(e){preventTouchDefault(e);if(!state.isDrawing||!ctx){return}const pos=getEventPos(e);ctx.lineTo(pos.x,pos.y);ctx.stroke()})});$document.off('mouseup.playback touchend.playback mouseleave.playback touchcancel.playback').on('mouseup.playback touchend.playback mouseleave.playback touchcancel.playback',function(e){preventTouchDefault(e);if(state.isDrawing&&ctx){state.isDrawing=false;ctx.globalCompositeOperation='source-over';$document.off('mousemove.playback touchmove.playback')}});$zoomInBtn.off('click.playback').on('click.playback',function(){if(state.zoomScale<CONFIG.ZOOM.max){state.zoomScale=Math.round((state.zoomScale+CONFIG.ZOOM.step)*10)/10;updateZoom()}});$zoomOutBtn.off('click.playback').on('click.playback',function(){if(state.zoomScale>CONFIG.ZOOM.min){state.zoomScale=Math.round((state.zoomScale-CONFIG.ZOOM.step)*10)/10;updateZoom()}});$zoomResetBtn.off('click.playback').on('click.playback',resetZoom);$window.off('resize.playback').on('resize.playback',function(){if($main.hasClass('active')){throttledInitCanvas()}});$document.off('keydown.playback').on('keydown.playback',function(e){if(e.key==='Escape'){if(state.isTOCActive){hideTOC()}else if(isFullscreenMode()){exitFullscreen()}else if($main.hasClass('active')){$exitBtn.click()}}});state.isEventsBound=true}function destroyEvents(){$tocCloseBtn.off('.playback');$tocBtn.off('.playback');$document.off('.playback');$fullscreenBtn.off('.playback');$exitBtn.off('.playback');$disableDrawBtn.off('.playback');$drawBtn.off('.playback');$eraserBtn.off('.playback');$sizeDownBtn.off('.playback');$sizeUpBtn.off('.playback');$colorPicker.off('.playback');$clearBtn.off('.playback');$canvas.off('.playback');$window.off('.playback');$playbackTOC.off('.playback');$tocList.off('.playback');if(ctx){ctx.clearRect(0,0,$window.width(),$window.height());ctx=null}clearTimeout(window.playbackFullscreenTimer);state.isDrawing=false;state.isEraserActive=false;state.zoomScale=1.0;state.isTOCActive=false;state.currentSizeIndex=CONFIG.DEFAULT_BRUSH_SIZE_INDEX;state.brushColor=CONFIG.DEFAULT_BRUSH_COLOR;state.isEventsBound=false}$enterPlayback.off('click.playback-global').on('click.playback-global',function(){$originalContent=$('.post-content');if(!$originalContent.length){return}$playbackContent.empty();$playbackContent.html($originalContent.prop('outerHTML'));$playbackContent.find('.aisummary').remove();forceLoadLazyImages($playbackContent);renderTOC();$main.addClass('active');$toolbar.show();$body.css('overflow','hidden');initCanvas();disableDrawMode();resetZoom();updateBrushSize();updateZoom();clearTimeout(window.playbackFullscreenTimer);window.playbackFullscreenTimer=setTimeout(enterFullscreen,50);const scrollContainer=$main[0];scrollContainer.scrollTop=0;state.isEventsBound=false;bindEvents()})});
